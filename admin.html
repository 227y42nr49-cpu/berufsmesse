<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Gewinner & Auswertung</title>

<!-- Supabase v2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: -apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f4f4f4; color:#333; padding:20px; }
h1 { text-align:center; margin-bottom:30px; }
.container { max-width:800px; margin:0 auto; background:white; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th, td { padding:10px; text-align:center; border:1px solid #ddd; }
th { background:#2a5298; color:white; }
.button { margin-top:15px; padding:10px 20px; background:#2a5298; color:white; border:none; border-radius:5px; cursor:pointer; }
.button:hover { background:#1e3c72; }
</style>
</head>

<body>
<div class="container">
<h1>Admin â€“ Auswertung & Gewinner</h1>

<!-- Passwort -->
<div>
<label>Passwort: </label>
<input type="password" id="adminPass">
<button class="button" id="loginBtn">Login</button>
<div id="loginStatus" style="margin-top:10px;color:red;"></div>
</div>

<!-- Teilnehmer Tabelle -->
<div id="adminContent" style="display:none;">
<label>Mindestanzahl StÃ¤nde: </label>
<input type="number" id="minStands" value="10" min="1" style="width:60px;">
<button class="button" id="refreshBtn">Aktualisieren</button>
<button class="button" id="drawWinnerBtn">Gewinner ziehen</button>

<table id="participantsTable">
<thead>
<tr>
<th>Teilnehmer-ID</th>
<th>Besuchte StÃ¤nde</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="winnerResult" style="margin-top:15px; font-weight:bold; color:green;"></div>
</div>

<script>
/* =========================
   Supabase v2 Client
========================= */
const SUPABASE_URL = "https://jxrmhslzokgezakboufx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4cm1oc2x6b2tnZXph..."; // Dein anon key
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   Passwort Schutz
========================= */
const adminPassword = "Messe2026gho!";
document.getElementById("loginBtn").addEventListener("click", () => {
  const pass = document.getElementById("adminPass").value;
  if(pass === adminPassword){
    document.getElementById("adminContent").style.display="block";
    document.getElementById("loginStatus").innerText="";
    loadParticipants();
  } else {
    document.getElementById("loginStatus").innerText="Falsches Passwort!";
  }
});

/* =========================
   Teilnehmer laden
========================= */
let availableWinners = []; // FÃ¼r Mehrfach-Gewinner

async function loadParticipants() {

  const minStands = parseInt(document.getElementById("minStands").value) || 1;

  const { data, error } = await supabaseClient
    .from('visits')
    .select('*');

  console.log("RAW DATA:", data);

  if (error) {
    console.error(error);
    return;
  }

  const counts = {};

  data.forEach(row => {

    const pid = row.participant_id;
    const sid = row.stand_id;

    if (!pid || !sid) return;

    if (!counts[pid]) counts[pid] = new Set();

    counts[pid].add(String(sid)); // <<< bewusst als STRING
  });

  console.log("COUNTS:", counts);

  const filtered = Object.entries(counts)
    .filter(([id, stands]) => stands.size >= minStands);

  console.log("FILTERED:", filtered);

  const tbody = document.querySelector("#participantsTable tbody");
  tbody.innerHTML = "";

  filtered.forEach(([id, stands]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${id}</td><td>${stands.size}</td>`;
    tbody.appendChild(tr);
  });

  availableWinners = [...filtered];

  console.log("AVAILABLE WINNERS:", availableWinners);
}

/* =========================
   Aktualisieren Button
========================= */
document.getElementById("refreshBtn").addEventListener("click", loadParticipants);

/* =========================
   Gewinner ziehen (mehrfach)
========================= */
document.getElementById("drawWinnerBtn").addEventListener("click", ()=>{
  if(availableWinners.length === 0){
    document.getElementById("winnerResult").innerText = "Alle Gewinner wurden bereits gezogen oder keine Teilnehmer erfÃ¼llt die Mindestanzahl!";
    return;
  }

  const index = Math.floor(Math.random() * availableWinners.length);
  const [winnerId, winnerStands] = availableWinners.splice(index,1)[0];

  document.getElementById("winnerResult").innerText =
    `ðŸŽ‰ Gewinner: ${winnerId} (StÃ¤nde: ${winnerStands.size})`;
});
</script>

</body>
</html>
