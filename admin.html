<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Stand-Check</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.10.0/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://jxrmhslzokgezakboufx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4cmhsc2x6b2tnZXpha2JvdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTg3OTMsImV4cCI6MjA4NTUzNDc5M30.wskrw2Qvp2FbNCFJ5SfsmMl_DMOtze9ztqn9PGlsg0I";
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<style>
body {
  margin:0;
  font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background: linear-gradient(135deg,#1e3c72,#2a5298);
  color:white;
  text-align:center;
}
.container { padding:30px 20px; }
.card {
  background:white; color:#333; border-radius:20px; padding:30px; margin-top:30px;
  box-shadow:0 10px 25px rgba(0,0,0,0.25);
  animation:fadeIn 0.6s ease-in-out;
  max-width:600px; margin-left:auto; margin-right:auto;
}
h1 { font-size:24px; margin-top:0; }
input[type="password"] { padding:10px; width:60%; border-radius:10px; border:none; margin-top:15px; }
.button {
  display:inline-block; margin-top:15px; padding:12px 20px; border-radius:30px;
  background:#2a5298; color:white; text-decoration:none; font-weight:bold; transition:0.3s; cursor:pointer;
}
.button:hover { background:#1e3c72; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th,td { padding:10px; border:1px solid #ccc; color:#333; text-align:left; }
@keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>

<body>
<div class="container">
<h1>üîí Admin Stand-Check</h1>

<div class="card" id="loginCard">
  <p>Bitte Passwort eingeben:</p>
  <input type="password" id="adminPassword" placeholder="Passwort"/>
  <div class="button" id="loginBtn">Einloggen</div>
  <p id="loginStatus" style="color:red;"></p>
</div>

<div class="card" id="adminContent" style="display:none;">
  <h2>Teilnehmer & Besuche</h2>
  <div id="participants"></div>
  <div style="margin-top:20px;">
    <input type="number" id="minStands" value="10" style="width:60px;"/>
    <span>Minimale St√§nde f√ºr Gewinner</span>
    <div class="button" id="drawWinnerBtn">üéâ Gewinner ziehen</div>
    <div id="winnerOutput" style="margin-top:15px; font-weight:bold; color:green;"></div>
  </div>
</div>

<script>
// 1Ô∏è‚É£ Passwortschutz
document.getElementById("loginBtn").addEventListener("click",()=>{
  const pw = document.getElementById("adminPassword").value;
  if(pw==="Messe2026gho!"){
    document.getElementById("loginCard").style.display="none";
    document.getElementById("adminContent").style.display="block";
    loadParticipants();
  } else {
    document.getElementById("loginStatus").innerText="‚ùå Falsches Passwort";
  }
});

// 2Ô∏è‚É£ Teilnehmer laden
async function loadParticipants(){
  const { data, error } = await supabase
    .from('visits')
    .select('*');

  if(error){ console.error(error); return; }

  // Gruppieren nach participant_id
  const participants = {};
  data.forEach(row=>{
    if(!participants[row.participant_id]) participants[row.participant_id]=[];
    participants[row.participant_id].push(row.stand_id);
  });

  const container = document.getElementById("participants");
  container.innerHTML = "<table><tr><th>Teilnehmer-ID</th><th>Besuchte St√§nde (#)</th></tr>"+
    Object.keys(participants).map(pid=>`<tr><td>${pid}</td><td>${participants[pid].join(", ")}</td></tr>`).join("")+
    "</table>";

  window.participantsData = participants; // global f√ºr Gewinnerziehen
}

// 3Ô∏è‚É£ Gewinner ziehen
document.getElementById("drawWinnerBtn").addEventListener("click",()=>{
  const minStands = parseInt(document.getElementById("minStands").value) || 10;
  const eligible = Object.entries(window.participantsData || {})
    .filter(([pid, stands])=>stands.length>=minStands)
    .map(([pid])=>pid);

  if(eligible.length===0){
    document.getElementById("winnerOutput").innerText="‚ùå Keine Teilnehmer erf√ºllen die Mindestanforderung";
    return;
  }

  // Zuf√§llig Gewinner ausw√§hlen (1 Gewinner)
  const winner = eligible[Math.floor(Math.random()*eligible.length)];
  document.getElementById("winnerOutput").innerText=`üèÜ Gewinner: ${winner}`;
});
</script>

</body>
</html>
