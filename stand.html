<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stand-Check</title>

<!-- Supabase v2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="data.js"></script>

<script>

const SUPABASE_URL = "https://jxrmhslzokgezakboufx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4cm1oc2x6b2tnZXpha2JvdWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTg3OTMsImV4cCI6MjA4NTUzNDc5M30.wskrw2Qvp2FbNCFJ5SfsmMl_DMOtze9ztqn9PGlsg0I"; // ‚Üê falls n√∂tig einsetzen

// WICHTIG: nicht "supabase" nennen!
const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);
</script>

<style>
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  color:white;
  text-align:center;
}
.container { padding:30px 20px; }
.card {
  background:white;
  color:#333;
  border-radius:20px;
  padding:30px;
  margin-top:40px;
  box-shadow:0 10px 25px rgba(0,0,0,0.25);
}
h1 { margin-top:40px; font-size:24px; }
.company { font-size:22px; font-weight:bold; margin-bottom:10px; }
.area { font-size:16px; color:#666; margin-bottom:20px; }
.success { margin-top:15px; font-weight:bold; }
.button {
  display:inline-block;
  margin-top:25px;
  padding:14px 24px;
  border-radius:30px;
  background:#2a5298;
  color:white;
  text-decoration:none;
  font-weight:bold;
}
</style>
</head>

<body>
<div class="container">
<h1>üéØ Stand erfolgreich gescannt</h1>

<div class="card">
  <div class="company" id="company"></div>
  <div class="area" id="area"></div>
  <div>Stand-Nr.: <strong id="standNum"></strong></div>
  <div id="status" class="success"></div>
  <a href="index.html" class="button">üîô Zur√ºck zum Fortschritt</a>
</div>
</div>

<script>
/* =========================
   STAND-ID AUS URL
========================= */

const params = new URLSearchParams(window.location.search);
const sid = params.get("sid");

if (!sid) {
  alert("Ung√ºltiger QR-Code");
  throw new Error("Keine Stand-ID");
}

/* =========================
   TEILNEHMER-ID
========================= */

let participantId = localStorage.getItem("participantId");

if (!participantId) {
  participantId = "T-" + Math.random().toString(36).substring(2,8).toUpperCase();
  localStorage.setItem("participantId", participantId);
}

/* =========================
   STANDDATEN ANZEIGEN
========================= */

const standData = stands[sid];

if (!standData) {
  alert("Unbekannter Stand");
  throw new Error("Stand nicht gefunden");
}

document.getElementById("company").innerText = standData.name;
document.getElementById("area").innerText = standData.area;
document.getElementById("standNum").innerText = sid;

/* =========================
   LOCALSTORAGE BESUCHE
========================= */

let visits = JSON.parse(localStorage.getItem("visits")) || [];
let alreadyVisited = visits.includes(sid);

if (!alreadyVisited) {
  visits.push(sid);
  localStorage.setItem("visits", JSON.stringify(visits));
}

/* =========================
   SUPABASE SPEICHERN
========================= */

async function saveStand() {

  if (alreadyVisited) {
    document.getElementById("status").innerText =
      "‚Ñπ Dieser Stand wurde bereits gez√§hlt.";
    return;
  }

  const { data, error } = await supabaseClient
    .from('visits')
    .insert([
      {
        participant_id: participantId,
        stand_id: parseInt(sid)
      }
    ]);

  if (error) {
    console.error("Supabase Fehler:", error);
    document.getElementById("status").innerText =
      "‚ùå Fehler beim Speichern";
  } else {
    document.getElementById("status").innerText =
      "‚úÖ Besuch erfolgreich gespeichert!";
  }
}

saveStand();
</script>

</body>
</html>
